<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
  <base href="/Income-expense/">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard</title>

<link rel="stylesheet" href="css/style.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

<div class="navbar">
<div class="nav-left">ðŸ’° Expense Tracker</div>
<div class="nav-right">
<a href="profile.html">Profile</a>
<button id="logoutBtn" class="nav-btn">Logout</button>
</div>
</div>

<div class="container">

<div class="cards">
<div class="card"><h3>Main Balance</h3><p id="balance">0</p></div>
<div class="card"><h3>Total Income</h3><p id="income" class="income">0</p></div>
<div class="card"><h3>Total Expense</h3><p id="expense" class="expense">0</p></div>
</div>

<div class="list">
<h3>Transactions</h3>

<table class="sheet">
<thead>
<tr>
<th>Date</th>
<th>Type</th>
<th>Category</th>
<th>Amount</th>
</tr>
</thead>

<tbody id="transactions"></tbody>
</table>

</div>

<div class="list">
<h3>Analytics</h3>
<canvas id="barChart"></canvas>
<canvas id="pieChart"></canvas>
</div>

</div>

<button id="openModal" class="addBtn">+</button>

<div id="modal" class="modal">
<div class="modalBox">

<h3>Add Transaction</h3>

<select id="type">
<option value="income">Income</option>
<option value="expense">Expense</option>
</select>

<input id="amount" type="number" placeholder="Amount">
<input id="note" placeholder="Category / Note">

<button id="saveBtn">Save</button>
<button id="closeModal">Cancel</button>

</div>
</div>


<script type="module">

import { auth, db } from "./js/firebase.js";

import { signOut, onAuthStateChanged }
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

import {
collection, addDoc, getDocs, query, orderBy,
serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";


// ===== DOM SAFE REFERENCES (IMPORTANT FOR GITHUB) =====
const modal=document.getElementById("modal");
const openModal=document.getElementById("openModal");
const closeModal=document.getElementById("closeModal");
const saveBtn=document.getElementById("saveBtn");

const balance=document.getElementById("balance");
const incomeEl=document.getElementById("income");
const expenseEl=document.getElementById("expense");
const table=document.getElementById("transactions");


// ===== UI =====
openModal.onclick=()=> modal.style.display="flex";
closeModal.onclick=()=> modal.style.display="none";

logoutBtn.onclick=()=> signOut(auth).then(()=>location.href="login.html");


// ===== SAVE =====
saveBtn.onclick=async()=>{

const typeVal=document.getElementById("type").value;
const amountVal=Number(document.getElementById("amount").value);
const noteVal=document.getElementById("note").value;

if(!amountVal||amountVal<=0){
alert("Enter valid amount");
return;
}

const user=auth.currentUser;
if(!user){
alert("Login required");
return;
}

await addDoc(
collection(db,"users",user.uid,"transactions"),
{
type:typeVal,
amount:amountVal,
note:noteVal,
createdAt:serverTimestamp(),
time:new Date().toISOString()
}
);

modal.style.display="none";
document.getElementById("amount").value="";
document.getElementById("note").value="";

load();

};


// ===== CHARTS =====
let barChart=null;
let pieChart=null;


// ===== LOAD =====
async function load(){

const user=auth.currentUser;
if(!user) return;

const q=query(
collection(db,"users",user.uid,"transactions"),
orderBy("createdAt","desc")
);

const snap=await getDocs(q);

table.innerHTML="";

let income=0;
let expense=0;
let cats={};

snap.forEach(d=>{

const t=d.data();
const amt=Number(t.amount)||0;
const dateObj=t.createdAt?.toDate?.()||new Date(t.time);

if(t.type==="income") income+=amt;
else{
expense+=amt;
const cat=t.note||"Other";
cats[cat]=(cats[cat]||0)+amt;
}

const tr=document.createElement("tr");

tr.innerHTML=`
<td>${dateObj.toLocaleDateString()} ${dateObj.toLocaleTimeString()}</td>
<td style="color:${t.type==="income"?"green":"red"}">${t.type}</td>
<td>${t.note||"-"}</td>
<td style="color:${t.type==="income"?"green":"red"}">
${t.type==="income"?"+":"-"}${amt}
</td>
`;

table.appendChild(tr);

});

balance.textContent=income-expense;
incomeEl.textContent=income;
expenseEl.textContent=expense;

drawCharts(income,expense,cats);

}


// ===== DRAW CHARTS =====
function drawCharts(i,e,c){

if(barChart)barChart.destroy();
if(pieChart)pieChart.destroy();

barChart=new Chart(document.getElementById("barChart"),{
type:"bar",
data:{labels:["Income","Expense"],
datasets:[{label:"Amount",data:[i,e]}]}
});

pieChart=new Chart(document.getElementById("pieChart"),{
type:"pie",
data:{labels:Object.keys(c),
datasets:[{data:Object.values(c)}]}
});

}


// ===== AUTH LOAD =====
onAuthStateChanged(auth,u=>{
if(u) load();
else location.href="login.html";
});

</script>

</body>
</html>
